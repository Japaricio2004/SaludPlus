<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SaludPlus</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .dashboard-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .header-left {
            flex: 1;
            min-width: 250px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            align-items: flex-end;
        }

        .welcome-text {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .main-title {
            font-size: 2.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.3rem;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.05rem;
        }

        .actions-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 0.85rem 1.6rem;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.5);
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-logout:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-small {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        .flash {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .filters-section {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(46, 204, 113, 0.05));
            padding: 1.8rem;
            border-radius: 16px;
            margin-bottom: 2.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid rgba(52, 152, 219, 0.1);
        }

        .filters-form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-input {
            padding: 0.75rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            min-width: 150px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-filter {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-clear {
            color: #3498db;
            text-decoration: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-clear:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 1.3rem 1.2rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-bottom: 3px solid #1e2a38;
        }

        td {
            padding: 1.3rem 1.2rem;
            border-bottom: 1px solid #e8eef3;
            vertical-align: middle;
            font-size: 0.95rem;
            color: #2c3e50;
        }

        td strong {
            color: #1e3c72;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: rgba(52, 152, 219, 0.03);
        }

        tr:hover {
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.08), rgba(46, 204, 113, 0.05));
            transition: all 0.3s ease;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 0.65rem 1.2rem;
            border: none;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 0.65rem 1.2rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-top: 2.5rem;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(52, 152, 219, 0.1);
        }

        #metricasChart {
            flex: 1;
            min-height: 350px;
            max-height: 450px;
            width: 100% !important;
        }

        .chart-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid rgba(52, 152, 219, 0.1);
        }

        .chart-title i {
            color: #3498db;
            font-size: 1.6rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            color: #bdc3c7;
            opacity: 0.4;
        }

        .empty-state h3 {
            font-size: 1.4rem;
            color: #34495e;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 1rem;
            color: #95a5a6;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: left;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #3498db, #2ecc71);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: #3498db;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.2;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        @media (max-width: 1024px) {
            .dashboard-container {
                padding: 1.5rem;
            }
            .stats-cards {
                grid-template-columns: 1fr 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-right {
                align-items: flex-start;
                width: 100%;
            }
            .main-title {
                font-size: 2.2rem;
            }
        }
        @media (max-width: 800px) {
            .dashboard-container {
                padding: 1rem;
                margin: 0.5rem;
                border-radius: 16px;
            }
            .main-title {
                font-size: 1.8rem;
            }
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }
            .btn-primary, .actions-bar label.btn-primary {
                width: 100%;
                justify-content: center;
                font-size: 0.95rem;
                padding: 0.8rem 1rem;
            }
            .filters-form {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }
            .filter-group {
                justify-content: flex-start;
            }
            .table-container {
                overflow-x: auto;
            }
            table {
                min-width: 520px;
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.8rem 0.5rem;
                word-break: break-word;
            }
            .stats-cards {
                grid-template-columns: 1fr;
            }
            .stat-card {
                padding: 1.5rem;
            }
            .chart-container {
                padding: 1rem;
                min-height: 300px;
            }
            #metricasChart {
                min-height: 200px;
            }
            .filters-section {
                padding: 1rem;
            }
            .chart-title {
                font-size: 1.3rem;
            }
        }
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 0.8rem;
            }
            .main-title {
                font-size: 1.5rem;
            }
            .stat-card .stat-value {
                font-size: 2rem;
            }
            .btn-primary, .actions-bar label.btn-primary {
                font-size: 0.9rem;
                padding: 0.7rem 0.8rem;
            }
            th, td {
                font-size: 0.85rem;
                padding: 0.6rem 0.3rem;
            }
            .filters-section {
                padding: 0.8rem;
            }
            .table-container td form input,
            .table-container td form button {
                font-size: 0.85rem !important;
                padding: 0.4rem !important;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    {% set comparativa_json = comparativa_json if comparativa_json is defined else None %}
    <!-- Modal de bienvenida y gu√≠a r√°pida -->
    <div id="welcomeModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(30,44,80,0.85);backdrop-filter:blur(2px);justify-content:center;align-items:center;">
        <div style="background:#fff;color:#232526;max-width:400px;width:90vw;padding:2rem 1.5rem 1.5rem 1.5rem;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;text-align:center;">
            <h2 style="margin-bottom:1rem;font-size:1.5rem;">¬°Bienvenido a tu Panel de Seguimiento Personal!</h2>
            <div id="guideSteps">
                <div class="guide-step">
                    <b>¬øQu√© es este panel?</b><br>
                    Aqu√≠ puedes llevar un registro de tus m√©tricas personales (como peso, sue√±o, h√°bitos, etc.) y ver tu progreso de manera visual y sencilla. ¬°No necesitas saber de tecnolog√≠a!
                </div>
                <div class="guide-step" style="display:none;">
                    <b>1. Agregar una m√©trica</b><br>
                    Haz clic en <span style="color:#3498db;font-weight:bold;">‚ûï Agregar M√©trica</span> para registrar un nuevo dato, como tu peso de hoy, cu√°ntos vasos de agua tomaste, horas de sue√±o, etc.<br>
                    <ul style='text-align:left;margin:0.5em 0 0 1em;'>
                        <li>Elige el tipo de m√©trica (ejemplo: Peso, Agua, Sue√±o...)</li>
                        <li>Escribe el valor (ejemplo: 70, 8, 2000...)</li>
                        <li>Puedes a√±adir una nota o categor√≠a si lo deseas</li>
                        <li>Guarda y ver√°s tu dato en la tabla</li>
                    </ul>
                </div>
                <div class="guide-step" style="display:none;">
                    <b>2. Consultar tus datos</b><br>
                    En la tabla puedes ver todas tus m√©tricas registradas. Usa el buscador o los filtros de fecha para encontrar datos espec√≠ficos.<br>
                    <ul style='text-align:left;margin:0.5em 0 0 1em;'>
                        <li>Puedes editar o eliminar cualquier dato usando los botones de la derecha</li>
                    </ul>
                </div>
                <div class="guide-step" style="display:none;">
                    <b>3. Ver tu progreso</b><br>
                    La gr√°fica muestra c√≥mo han cambiado tus m√©tricas a lo largo del tiempo. As√≠ puedes ver si mejoras o necesitas ajustar tus h√°bitos.<br>
                    <ul style='text-align:left;margin:0.5em 0 0 1em;'>
                        <li>Las tarjetas de arriba muestran totales y promedios</li>
                        <li>Las alertas y tendencias te avisan si vas bien o si debes prestar atenci√≥n</li>
                    </ul>
                </div>
                <div class="guide-step" style="display:none;">
                    <b>4. Gestionar categor√≠as</b><br>
                    Organiza tus m√©tricas en categor√≠as personalizadas desde <span style="color:#3498db;font-weight:bold;">üóÇÔ∏è Gestionar Categor√≠as</span>. As√≠ puedes separar, por ejemplo, salud, ejercicio, alimentaci√≥n, etc.
                </div>
                <div class="guide-step" style="display:none;">
                    <b>5. Exportar e importar datos</b><br>
                    Puedes descargar tus m√©tricas en Excel o CSV para guardarlas o analizarlas fuera de la app. Tambi√©n puedes importar datos si ya tienes un archivo.<br>
                    <ul style='text-align:left;margin:0.5em 0 0 1em;'>
                        <li>Usa los botones de Exportar/Importar en la barra de acciones</li>
                    </ul>
                </div>
                <div class="guide-step" style="display:none;">
                    <b>6. Personaliza tu experiencia</b><br>
                    Cambia el color principal, el modo claro/oscuro y el tama√±o de letra desde la parte superior derecha para que la app sea c√≥moda para ti.
                </div>
                <div class="guide-step" style="display:none;">
                    <b>¬øDudas?</b><br>
                    Si tienes preguntas, revisa esta gu√≠a de nuevo haciendo clic en <b>¬øC√≥mo funciona?</b> o consulta con quien te comparti√≥ la app.
                </div>
            </div>
            <div style="margin-top:1.5rem;">
                <button id="prevStep" class="btn-primary" style="display:none;">Anterior</button>
                <button id="nextStep" class="btn-primary">Siguiente</button>
                <button id="closeWelcome" class="btn-primary" style="display:none;">¬°Listo!</button>
            </div>
        </div>
    </div>
    <div class="dashboard-container" role="main" aria-label="Panel principal de m√©tricas">
        <div class="header">
            <div class="header-left">
                <p class="welcome-text">Bienvenido(a), <strong>{{ current_user.username }}</strong></p>
                <h1 class="main-title">üìä Dashboard</h1>
                <p class="subtitle">Gestiona y visualiza tus m√©tricas de forma eficiente</p>
            </div>
            <div class="header-right">
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                    <a href="{{ url_for('main.perfil') }}" class="btn-primary btn-small" title="Gestionar mi perfil" style="text-decoration:none;">
                        <i class="fas fa-user-circle"></i> Mi Perfil
                    </a>
                    <button id="showGuide" class="btn-primary btn-small" title="Ver gu√≠a r√°pida de uso">‚ùì Ayuda</button>
                    <form id="logoutForm" action="{{ url_for('main.logout') }}" method="get" style="display:inline;">
                        <button type="submit" class="btn-primary btn-logout btn-small">üö™ Salir</button>
                    </form>
                    <script>
                    document.getElementById('logoutForm').addEventListener('submit', function() {
                        localStorage.removeItem('welcomeSeen');
                    });
                    </script>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <h3>üìä Total M√©tricas</h3>
                        <div class="stat-value" id="totalMetrics">{{ metricas|length }}</div>
                    </div>
                    <div class="stat-icon">üìà</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <h3>üìÖ M√©tricas Hoy</h3>
                        <div class="stat-value" id="todayMetrics">{{ metricas_hoy }}</div>
                    </div>
                    <div class="stat-icon">üóìÔ∏è</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <h3>üè∑Ô∏è Categor√≠as</h3>
                        <div class="stat-value" id="totalCategories">{{ total_categorias }}</div>
                    </div>
                    <div class="stat-icon">üìÅ</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <h3>üïê √öltima Actualizaci√≥n</h3>
                        <div class="stat-value" id="lastUpdate" style="font-size: 1.3rem;">Hoy</div>
                    </div>
                    <div class="stat-icon">‚è∞</div>
                </div>
            </div>
        </div>
        <!-- Calendario de m√©tricas -->
        <div style="margin-bottom:2rem;">
            <h2 class="chart-title">üìÖ Calendario de M√©tricas</h2>
            <div id="calendarContainer" style="max-width:400px;margin:0 auto;"></div>
        </div>
        <script id="fechasMetricasData" type="application/json">
            {{ fechas_metricas_json|safe }}
        </script>

        <div class="actions-bar">
            <a href="{{ url_for('main.agregar_metrica') }}" class="btn-primary">
                <i class="fas fa-plus-circle"></i> Agregar M√©trica
            </a>
            <a href="{{ url_for('main.categories') }}" class="btn-primary">
                <i class="fas fa-folder-open"></i> Categor√≠as
            </a>
            <a href="{{ url_for('main.exportar_metricas', formato='csv') }}" class="btn-primary" title="Exportar m√©tricas a CSV">
                <i class="fas fa-file-csv"></i> CSV
            </a>
            <a href="{{ url_for('main.exportar_metricas', formato='excel') }}" class="btn-primary" title="Exportar m√©tricas a Excel">
                <i class="fas fa-file-excel"></i> Excel
            </a>
            <form action="{{ url_for('main.importar_metricas') }}" method="post" enctype="multipart/form-data" style="display:inline;">
                <label class="btn-primary" style="margin:0;cursor:pointer;">
                    <i class="fas fa-file-upload"></i> Importar
                    <input type="file" name="archivo" accept=".csv,.xlsx" style="display:none;" onchange="this.form.submit()">
                </label>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash">‚úÖ {{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {# Tendencias #}
        {% if tendencias %}
          {% for tipo, mensaje in tendencias.items() %}
            {% if mensaje %}
              <div style="margin-bottom:1rem;padding:1rem;border-radius:12px;background:linear-gradient(135deg,#2980b9,#6dd5fa);color:white;font-weight:500;box-shadow:0 4px 15px rgba(52,152,219,0.18);text-align:center;">
                üìà {{ mensaje }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Alertas #}
        {% if alertas %}
          {% for tipo, alerta in alertas.items() %}
            {% if alerta %}
              <div style="margin-bottom:1rem;padding:1rem;border-radius:12px;background:linear-gradient(135deg,#e74c3c,#f39c12);color:white;font-weight:600;box-shadow:0 4px 15px rgba(231,76,60,0.18);text-align:center;">
                ‚ö†Ô∏è {{ alerta }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <div class="filters-section">
            <form method="get" class="filters-form">
                <div class="filter-group">
                    <input type="text" name="q" id="searchInput" class="filter-input" 
                           placeholder="üîç Buscar por tipo..." value="{{ request.args.get('q', '') }}">
                </div>
                <div class="filter-group">
                    <label>Desde:</label>
                    <input type="date" name="fecha_inicio" class="filter-input" 
                           value="{{ request.args.get('fecha_inicio', '') }}">
                </div>
                <div class="filter-group">
                    <label>Hasta:</label>
                    <input type="date" name="fecha_fin" class="filter-input" 
                           value="{{ request.args.get('fecha_fin', '') }}">
                </div>
                <button type="submit" class="btn-filter">üîç Filtrar</button>
                <a href="{{ url_for('main.dashboard') }}" class="btn-clear">üóëÔ∏è Limpiar</a>
            </form>
        </div>

        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando m√©tricas...</p>
        </div>

        <div style="margin-top:2.5rem;">
            <h2 class="chart-title">
                <i class="fas fa-database"></i> Registro de M√©tricas
            </h2>
            
            {% if metricas %}
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:1.8rem;margin-top:2rem;">
                {% for metrica in metricas %}
                <div data-metric-card style="background:white;border-radius:18px;padding:1.8rem;box-shadow:0 6px 20px rgba(0,0,0,0.08);border-top:4px solid #3498db;transition:all 0.3s ease;position:relative;overflow:hidden;" 
                     onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 12px 35px rgba(0,0,0,0.15)';" 
                     onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.08)';">
                    <!-- Borde decorativo superior con gradiente -->
                    <div style="position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#3498db,#2ecc71,#f39c12);"></div>
                    
                    <!-- Header de la tarjeta con tipo y categor√≠a -->
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.2rem;">
                        <div style="flex:1;">
                            <h3 style="font-size:1.4rem;font-weight:700;color:#2c3e50;margin:0 0 0.5rem 0;display:flex;align-items:center;gap:0.5rem;">
                                <i class="fas fa-chart-line" style="color:#3498db;"></i>
                                {{ metrica.nombre }}
                            </h3>
                            {% if metrica.categoria %}
                            <span style="display:inline-block;background:linear-gradient(135deg,rgba(52,152,219,0.1),rgba(46,204,113,0.1));color:#2c3e50;padding:0.35rem 0.9rem;border-radius:20px;font-size:0.8rem;font-weight:600;border:1px solid rgba(52,152,219,0.2);">
                                <i class="fas fa-folder" style="font-size:0.75rem;"></i> {{ metrica.categoria.nombre }}
                            </span>
                            {% endif %}
                        </div>
                        <div style="font-size:0.85rem;color:#95a5a6;text-align:right;white-space:nowrap;margin-left:1rem;">
                            <i class="fas fa-calendar-alt" style="color:#3498db;"></i>
                            {% if metrica.fecha %}
                                {{ metrica.fecha.strftime('%d/%m/%Y') }}
                            {% else %}
                                Sin fecha
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Valor principal destacado -->
                    <div style="background:linear-gradient(135deg,rgba(52,152,219,0.08),rgba(46,204,113,0.05));border-radius:15px;padding:1.5rem;margin-bottom:1rem;text-align:center;border:2px solid rgba(52,152,219,0.15);">
                        <div style="font-size:0.8rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.5rem;font-weight:600;">
                            Valor Registrado
                        </div>
                        <div style="font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#1e3c72,#2a5298);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;">
                            {{ metrica.valor }}
                            {% if metrica.unidad %}
                            <span style="font-size:1.3rem;font-weight:600;color:#7f8c8d;margin-left:0.3rem;">{{ metrica.unidad }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Nota (si existe) -->
                    {% if metrica.nota %}
                    <div style="background:rgba(243,156,18,0.05);border-left:3px solid #f39c12;padding:1rem;border-radius:8px;margin-bottom:1rem;">
                        <div style="font-size:0.75rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.4rem;font-weight:600;">
                            <i class="fas fa-sticky-note"></i> Nota
                        </div>
                        <div style="font-size:0.9rem;color:#34495e;line-height:1.5;">
                            {{ metrica.nota }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Botones de acci√≥n -->
                    <div style="display:flex;gap:0.8rem;justify-content:stretch;">
                        <a href="{{ url_for('main.editar_metrica', id=metrica.id) }}" 
                           style="flex:1;display:flex;align-items:center;justify-content:center;gap:0.5rem;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:0.8rem 1.2rem;border:none;border-radius:12px;text-decoration:none;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(243,156,18,0.25);"
                           onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(243,156,18,0.4)';"
                           onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(243,156,18,0.25)';">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <form action="{{ url_for('main.eliminar_metrica', id=metrica.id) }}" method="post" style="flex:1;">
                            <button type="submit" 
                                    onclick="return confirm('¬øSeguro que deseas eliminar esta m√©trica?');"
                                    style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.5rem;background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;padding:0.8rem 1.2rem;border:none;border-radius:12px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(231,76,60,0.25);"
                                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(231,76,60,0.4)';"
                                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(231,76,60,0.25)';">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="background:white;border-radius:20px;padding:4rem 2rem;box-shadow:0 6px 20px rgba(0,0,0,0.08);text-align:center;margin-top:2rem;">
                <div style="font-size:5rem;margin-bottom:1.5rem;opacity:0.2;">üìä</div>
                <h3 style="font-size:1.6rem;color:#34495e;margin-bottom:0.8rem;font-weight:700;">No hay m√©tricas registradas</h3>
                <p style="font-size:1.1rem;color:#95a5a6;margin-bottom:2rem;">Comienza agregando tu primera m√©trica para empezar a trackear tu salud</p>
                <a href="{{ url_for('main.agregar_metrica') }}" style="display:inline-flex;align-items:center;gap:0.5rem;background:linear-gradient(135deg,#2c3e50,#34495e);color:white;padding:1rem 2rem;border-radius:12px;text-decoration:none;font-weight:600;font-size:1.05rem;box-shadow:0 4px 15px rgba(44,62,80,0.3);transition:all 0.3s ease;">
                    <i class="fas fa-plus-circle"></i> Agregar Primera M√©trica
                </a>
            </div>
            {% endif %}
        </div>

        <div class="chart-container">
            <h2 class="chart-title">
                <i class="fas fa-chart-line"></i> Evoluci√≥n de M√©tricas
            </h2>
            <canvas id="metricasChart"></canvas>
        </div>

        <!-- Estad√≠sticas por tipo de m√©trica -->
        <div style="margin-top:3rem;">
            <h2 class="chart-title">
                <i class="fas fa-chart-bar"></i> Estad√≠sticas por Tipo de M√©trica
            </h2>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:2rem;margin-top:2rem;">
            {% for tipo, data in stats.items() %}
                <div style="background:white;border-radius:20px;padding:2rem;box-shadow:0 8px 25px rgba(0,0,0,0.1);border-left:5px solid #3498db;transition:all 0.3s ease;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                        <h3 style="font-size:1.5rem;font-weight:700;color:#2c3e50;margin:0;">
                            <i class="fas fa-tag" style="color:#3498db;margin-right:0.5rem;"></i>{{ tipo }}
                        </h3>
                        <span style="background:linear-gradient(135deg,#3498db,#2ecc71);color:white;padding:0.4rem 1rem;border-radius:20px;font-size:0.85rem;font-weight:600;">
                            {{ data.unidad }}
                        </span>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem;">
                        <div style="text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(52,152,219,0.1),rgba(46,204,113,0.05));border-radius:12px;border:2px solid rgba(52,152,219,0.2);">
                            <div style="font-size:0.75rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.3rem;font-weight:600;">
                                <i class="fas fa-chart-line"></i> Actual (Promedio)
                            </div>
                            <div style="font-size:1.8rem;font-weight:800;color:#2c3e50;">{{ data.promedio|round(1) }}</div>
                            <div style="font-size:0.7rem;color:#95a5a6;margin-top:0.2rem;">{{ data.unidad }}</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(46,204,113,0.08),rgba(39,174,96,0.05));border-radius:12px;">
                            <div style="font-size:0.75rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.3rem;font-weight:600;">
                                <i class="fas fa-arrow-up"></i> M√°ximo
                            </div>
                            <div style="font-size:1.5rem;font-weight:700;color:#27ae60;">{{ data.maximo|round(1) }}</div>
                            <div style="font-size:0.7rem;color:#95a5a6;margin-top:0.2rem;">Pico m√°s alto</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(243,156,18,0.08),rgba(230,126,34,0.05));border-radius:12px;">
                            <div style="font-size:0.75rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.3rem;font-weight:600;">
                                <i class="fas fa-arrow-down"></i> M√≠nimo
                            </div>
                            <div style="font-size:1.5rem;font-weight:700;color:#e67e22;">{{ data.minimo|round(1) }}</div>
                            <div style="font-size:0.7rem;color:#95a5a6;margin-top:0.2rem;">Punto m√°s bajo</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(155,89,182,0.08),rgba(142,68,173,0.05));border-radius:12px;">
                            <div style="font-size:0.75rem;color:#7f8c8d;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.3rem;font-weight:600;">
                                <i class="fas fa-database"></i> Registros
                            </div>
                            <div style="font-size:1.5rem;font-weight:700;color:#8e44ad;">{{ data.valores|length }}</div>
                            <div style="font-size:0.7rem;color:#95a5a6;margin-top:0.2rem;">Total mediciones</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(52,152,219,0.03);padding:1.2rem;border-radius:12px;margin-bottom:1rem;">
                        <div style="font-size:0.9rem;color:#7f8c8d;margin-bottom:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                            <i class="fas fa-bullseye"></i> Establecer Objetivo
                        </div>
                        <form method="post" style="display:flex;gap:0.6rem;align-items:flex-end;flex-wrap:wrap;">
                            <input type="hidden" name="objetivo_metrica" value="{{ tipo }}">
                            
                            <div style="flex:1;min-width:100px;">
                                <label style="display:block;font-size:0.8rem;color:#7f8c8d;margin-bottom:0.3rem;font-weight:600;">Valor Inicial</label>
                                <input type="number" step="any" name="valor_inicial" 
                                       value="{{ objetivos[tipo].valor_inicial if (objetivos[tipo] and objetivos[tipo].valor_inicial) else data.promedio|round(2) }}" 
                                       placeholder="Inicio" 
                                       style="width:100%;padding:0.7rem 1rem;border-radius:10px;border:2px solid #e0e6ed;font-size:0.95rem;font-weight:500;transition:all 0.3s;">
                            </div>
                            
                            <div style="flex:1;min-width:100px;">
                                <label style="display:block;font-size:0.8rem;color:#7f8c8d;margin-bottom:0.3rem;font-weight:600;">Meta</label>
                                <input type="number" step="any" name="valor_objetivo" 
                                       value="{{ objetivos[tipo].valor_objetivo if objetivos[tipo] else '' }}" 
                                       placeholder="Objetivo" 
                                       required
                                       style="width:100%;padding:0.7rem 1rem;border-radius:10px;border:2px solid #e0e6ed;font-size:0.95rem;font-weight:500;transition:all 0.3s;">
                            </div>
                            
                            <div style="width:90px;">
                                <label style="display:block;font-size:0.8rem;color:#7f8c8d;margin-bottom:0.3rem;font-weight:600;">Unidad</label>
                                <input type="text" name="unidad_objetivo" 
                                       value="{{ objetivos[tipo].unidad if objetivos[tipo] else data.unidad }}" 
                                       placeholder="kg" 
                                       style="width:100%;padding:0.7rem 1rem;border-radius:10px;border:2px solid #e0e6ed;font-size:0.95rem;font-weight:500;transition:all 0.3s;">
                            </div>
                            
                            <div>
                                <label style="display:block;font-size:0.8rem;color:#7f8c8d;margin-bottom:0.3rem;font-weight:600;">Direcci√≥n</label>
                                <select name="direccion_objetivo" style="padding:0.7rem 1rem;border-radius:10px;border:2px solid #e0e6ed;font-size:0.95rem;font-weight:500;background:white;cursor:pointer;transition:all 0.3s;">
                                    <option value="aumentar" {% if objetivos[tipo] and objetivos[tipo].direccion == 'aumentar' %}selected{% endif %}>üìà Aumentar</option>
                                    <option value="disminuir" {% if objetivos[tipo] and objetivos[tipo].direccion == 'disminuir' %}selected{% endif %}>üìâ Disminuir</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn-primary" style="padding:0.7rem 1.5rem;font-size:0.95rem;background:linear-gradient(135deg,#2c3e50,#34495e);border-radius:10px;box-shadow:0 3px 10px rgba(44,62,80,0.2);">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </form>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,rgba(46,204,113,0.05),rgba(52,152,219,0.03));padding:1.2rem;border-radius:12px;">
                        {% set objetivo = objetivos[tipo].valor_objetivo if objetivos[tipo] else None %}
                        {% set direccion = objetivos[tipo].direccion if (objetivos[tipo] and objetivos[tipo].direccion) else 'aumentar' %}
                        {% set valor_inicial = objetivos[tipo].valor_inicial if (objetivos[tipo] and objetivos[tipo].valor_inicial) else data.promedio %}
                        
                        {% if objetivo and objetivo != 0 %}
                        {% set obj_float = objetivo|float %}
                        {% set ini_float = valor_inicial|float %}
                        
                        {# Calcular progreso basado en valor inicial definido por usuario #}
                        {# Usar data.actual (valor m√°s reciente) en lugar de data.promedio #}
                        {% set valor_actual = data.actual if data.actual else data.promedio %}
                        {% if direccion == 'disminuir' %}
                            {# DISMINUIR: Ir de valor_inicial (mayor) a objetivo (menor) #}
                            {# Ejemplo: 100kg ‚Üí 80kg #}
                            {% if valor_actual <= obj_float %}
                                {% set progreso = 100.0 %}
                                {% set falta = 0.0 %}
                            {% else %}
                                {% set rango_total = ini_float - obj_float %}
                                {% if rango_total > 0 %}
                                    {% set avance = ini_float - valor_actual %}
                                    {% set progreso = (avance / rango_total * 100.0) %}
                                {% else %}
                                    {% set progreso = 100.0 %}
                                {% endif %}
                                {% set falta = valor_actual - obj_float %}
                            {% endif %}
                        {% else %}
                            {# AUMENTAR: Ir de valor_inicial (menor) a objetivo (mayor) #}
                            {# Ejemplo: 60kg ‚Üí 70kg #}
                            {% if valor_actual >= obj_float %}
                                {% set progreso = 100.0 %}
                                {% set falta = 0.0 %}
                            {% else %}
                                {% set rango_total = obj_float - ini_float %}
                                {% if rango_total > 0 %}
                                    {% set avance = valor_actual - ini_float %}
                                    {% set progreso = (avance / rango_total * 100.0) %}
                                {% else %}
                                    {% set progreso = 100.0 %}
                                {% endif %}
                                {% set falta = obj_float - valor_actual %}
                            {% endif %}
                        {% endif %}
                        
                        {# Limitar progreso entre 0 y 100 #}
                        {% set progreso = 0.0 if progreso < 0 else progreso %}
                        {% set progreso = 100.0 if progreso > 100 else progreso %}
                        {% set falta = 0.0 if falta < 0 else falta %}
                        
                        <div style="margin-bottom:0.8rem;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.9rem;color:#7f8c8d;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                <i class="fas fa-tasks"></i> Progreso {% if direccion == 'disminuir' %}üìâ{% else %}üìà{% endif %}
                            </span>
                            <span style="font-size:1.2rem;font-weight:700;color:#2c3e50;">{{ progreso|round(1) }}%</span>
                        </div>
                        
                        <div style="font-size:0.75rem;color:#95a5a6;margin-bottom:0.5rem;text-align:center;">
                            {{ ini_float|round(1) }} {{ data.unidad }} ‚Üí <strong style="color:#2c3e50;">{{ valor_actual|round(1) }} {{ data.unidad }}</strong> ‚Üí {{ obj_float|round(1) }} {{ data.unidad }}
                        </div>
                        
                        <div style="background:#ecf0f1;border-radius:15px;overflow:hidden;height:30px;width:100%;margin-bottom:0.8rem;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);">
                            {% if progreso >= 100 %}
                                {% set color_barra = 'linear-gradient(90deg,#2ecc71,#27ae60)' %}
                            {% elif progreso >= 50 %}
                                {% set color_barra = 'linear-gradient(90deg,#3498db,#2ecc71)' %}
                            {% else %}
                                {% set color_barra = 'linear-gradient(90deg,#f39c12,#e67e22)' %}
                            {% endif %}
                            {# Asegurar ancho m√≠nimo visible de 3% incluso cuando progreso es 0 #}
                            {% set ancho_barra = progreso if progreso > 3 else 3 %}
                            <div style="background:{{ color_barra }};height:100%;width:{{ ancho_barra|round(1) }}%;transition:width 0.5s ease;border-radius:15px;box-shadow:0 2px 8px rgba(46,204,113,0.3);"></div>
                        </div>
                        
                        {% if progreso >= 100 %}
                        <div style="text-align:center;padding:0.8rem;background:linear-gradient(135deg,#2ecc71,#27ae60);border-radius:10px;color:white;font-weight:600;">
                            <i class="fas fa-trophy" style="font-size:1.3rem;margin-right:0.5rem;"></i> ¬°Meta alcanzada!
                        </div>
                        {% else %}
                        <div style="text-align:center;color:#7f8c8d;font-size:0.95rem;">
                            {% if direccion == 'disminuir' %}
                                <i class="fas fa-arrow-down"></i> Faltan <strong style="color:#e74c3c;">{{ falta|round(2) }} {{ data.unidad }}</strong> por bajar
                            {% else %}
                                <i class="fas fa-arrow-up"></i> Faltan <strong style="color:#2ecc71;">{{ falta|round(2) }} {{ data.unidad }}</strong> por subir
                            {% endif %}
                        </div>
                        {% endif %}
                        {% else %}
                        <div style="text-align:center;padding:1.5rem;color:#bdc3c7;">
                            <i class="fas fa-info-circle" style="font-size:2rem;opacity:0.3;display:block;margin-bottom:0.5rem;"></i>
                            <span style="font-size:0.95rem;">Define un objetivo para ver tu progreso</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div style="background:white;border-radius:20px;padding:3rem;box-shadow:0 8px 25px rgba(0,0,0,0.1);text-align:center;grid-column:1/-1;">
                    <i class="fas fa-inbox" style="font-size:4rem;color:#bdc3c7;opacity:0.3;margin-bottom:1rem;"></i>
                    <h3 style="color:#7f8c8d;font-size:1.3rem;margin:0;">No hay datos para mostrar estad√≠sticas</h3>
                </div>
            {% endfor %}
            </div>
        </div>
    </div>

    <script id="metricasData" type="application/json">
        {{ metricas_json|safe }}
    </script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
    // Calendario simple de m√©tricas
    function renderCalendar(fechas) {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const diasMes = new Date(year, month + 1, 0).getDate();
        const primerDia = new Date(year, month, 1).getDay();
        let html = '<table style="width:100%;border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1rem;">';
        html += '<thead><tr style="background:linear-gradient(135deg,#34495e,#2c3e50);color:white;">';
        const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
        for (let d of dias) html += `<th style="padding:0.4rem;">${d}</th>`;
        html += '</tr></thead><tbody><tr>';
        let diaSemana = primerDia;
        if (diaSemana === 0) diaSemana = 7;
        for (let i = 1; i < diaSemana; i++) html += '<td></td>';
        for (let dia = 1; dia <= diasMes; dia++) {
            const fechaStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
            const tieneMetrica = fechas.includes(fechaStr);
            html += `<td style="padding:0.4rem;text-align:center;${tieneMetrica?'background:linear-gradient(135deg,#2ecc71,#27ae60);color:white;font-weight:bold;border-radius:6px;':''}">${dia}</td>`;
            if ((dia + diaSemana - 1) % 7 === 0) html += '</tr><tr>';
        }
        html += '</tr></tbody></table>';
        document.getElementById('calendarContainer').innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function() {
        const fechasMetricas = JSON.parse(document.getElementById('fechasMetricasData').textContent || '[]');
        renderCalendar(fechasMetricas);
    });
    </script>
    <script>
        // B√∫squeda mejorada en tiempo real para tarjetas
        const searchInput = document.getElementById('searchInput');
        const metricCards = document.querySelectorAll('[data-metric-card]');
        
        if (searchInput && metricCards.length > 0) {
            searchInput.addEventListener('input', function() {
                const filter = this.value.toLowerCase().trim();
                let visibleCount = 0;
                
                metricCards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    const shouldShow = text.includes(filter);
                    
                    card.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) visibleCount++;
                });
                
                // Mostrar mensaje si no hay resultados
                const gridContainer = metricCards[0]?.parentElement;
                if (gridContainer) {
                    let noResultsDiv = document.querySelector('.no-results-message');
                    
                    if (visibleCount === 0 && filter) {
                        if (!noResultsDiv) {
                            noResultsDiv = document.createElement('div');
                            noResultsDiv.className = 'no-results-message';
                            noResultsDiv.style.cssText = 'grid-column:1/-1;background:white;border-radius:20px;padding:3rem;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.08);';
                            noResultsDiv.innerHTML = `
                                <i class="fas fa-search" style="font-size:4rem;color:#bdc3c7;opacity:0.3;margin-bottom:1rem;"></i>
                                <h3 style="color:#7f8c8d;font-size:1.3rem;margin:0;">No se encontraron m√©tricas</h3>
                                <p style="color:#95a5a6;margin-top:0.5rem;">Intenta con otros t√©rminos de b√∫squeda</p>
                            `;
                            gridContainer.appendChild(noResultsDiv);
                        }
                    } else if (noResultsDiv) {
                        noResultsDiv.remove();
                    }
                }
            });
        }

        // Datos para la gr√°fica mejorada
        const metricasData = JSON.parse(document.getElementById('metricasData').textContent) || [];
        const filteredMetricasData = metricasData.filter(m => m.fecha && m.valor !== null);
        
        // Actualizar estad√≠sticas
        const today = new Date().toISOString().split('T')[0];
        const todayMetrics = filteredMetricasData.filter(m => m.fecha.startsWith(today)).length;
        const categories = [...new Set(filteredMetricasData.map(m => m.categoria).filter(c => c))];
        
        // document.getElementById('todayMetrics').textContent = todayMetrics;

        // Configuraci√≥n de colores profesionales
        const colors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
            '#34495e', '#16a085', '#27ae60', '#2980b9',
            '#8e44ad', '#d35400', '#c0392b', '#7f8c8d'
        ];

        // Generar gr√°fica si hay datos
        if (filteredMetricasData.length > 0) {
            const tipos = [...new Set(filteredMetricasData.map(m => m.nombre))];
            const datasets = tipos.map((tipo, index) => {
                const datosTipo = filteredMetricasData
                    .filter(m => m.nombre === tipo)
                    .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                // Gradiente para el fondo bajo la l√≠nea
                const ctx = document.getElementById('metricasChart').getContext('2d');
                let gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, colors[index % colors.length] + 'BB');
                gradient.addColorStop(1, 'rgba(255,255,255,0)');
                return {
                    label: tipo,
                    data: datosTipo.map(m => ({x: m.fecha, y: parseFloat(m.valor)})),
                    borderColor: colors[index % colors.length],
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.5,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: colors[index % colors.length],
                    pointBorderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    shadowBlur: 8,
                    shadowColor: colors[index % colors.length]
                };
            });

            const ctx = document.getElementById('metricasChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 14, weight: '600', family: 'Inter, sans-serif' },
                                color: '#2c3e50',
                                boxWidth: 12,
                                boxHeight: 12
                            }
                        },
                        title: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(44,62,80,0.97)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            cornerRadius: 12,
                            displayColors: true,
                            padding: 16,
                            caretSize: 10,
                            boxPadding: 10,
                            titleFont: { size: 15, weight: '700', family: 'Inter, sans-serif' },
                            bodyFont: { size: 14, weight: '500', family: 'Inter, sans-serif' },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { 
                                unit: 'day', 
                                tooltipFormat: 'dd/MM/yyyy',
                                displayFormats: { day: 'dd/MM' }
                            },
                            title: { 
                                display: true, 
                                text: 'üìÖ Fecha',
                                font: { size: 15, weight: '700', family: 'Inter, sans-serif' },
                                color: '#2c3e50',
                                padding: { top: 10 }
                            },
                            grid: { 
                                color: 'rgba(52,152,219,0.1)',
                                lineWidth: 1.5,
                                drawBorder: true,
                                borderColor: '#e0e6ed',
                                borderWidth: 2
                            },
                            ticks: { 
                                color: '#34495e', 
                                font: { size: 13, weight: '500', family: 'Inter, sans-serif' },
                                padding: 8
                            }
                        },
                        y: {
                            title: { 
                                display: true, 
                                text: 'üìä Valor',
                                font: { size: 15, weight: '700', family: 'Inter, sans-serif' },
                                color: '#2c3e50',
                                padding: { bottom: 10 }
                            },
                            grid: { 
                                color: 'rgba(52,152,219,0.1)',
                                lineWidth: 1.5,
                                drawBorder: true,
                                borderColor: '#e0e6ed',
                                borderWidth: 2
                            },
                            beginAtZero: false,
                            ticks: { 
                                color: '#34495e', 
                                font: { size: 13, weight: '500', family: 'Inter, sans-serif' },
                                padding: 8,
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 5,
                            hoverRadius: 8,
                            hoverBorderWidth: 3,
                            borderWidth: 2,
                            backgroundColor: '#ffffff'
                        },
                        line: {
                            borderWidth: 3.5,
                            tension: 0.4
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    hover: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        } else {
            document.querySelector('.chart-container').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìà</div>
                    <h3>No hay datos para mostrar en la gr√°fica</h3>
                    <p>Agrega algunas m√©tricas para ver su evoluci√≥n</p>
                </div>
            `;
        }

        // Efectos de animaci√≥n suaves
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.stat-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    card.style.transition = 'all 0.5s ease';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 100);
            });
        });

        // Confirmaci√≥n mejorada para eliminar
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar esta m√©trica?\n\nEsta acci√≥n no se puede deshacer.')) {
                    this.closest('form').submit();
                }
            });
        });
    </script>
    <script>
    // Gu√≠a r√°pida y modal de bienvenida
    function showWelcome(force=false) {
        if (!force && localStorage.getItem('welcomeSeen') === 'true') return;
        document.getElementById('welcomeModal').style.display = 'flex';
        let step = 0;
        const steps = document.querySelectorAll('#guideSteps .guide-step');
        const nextBtn = document.getElementById('nextStep');
        const prevBtn = document.getElementById('prevStep');
        const closeBtn = document.getElementById('closeWelcome');
        function updateStep() {
            steps.forEach((el,i)=>el.style.display = i===step?'block':'none');
            prevBtn.style.display = step>0?'inline-block':'none';
            nextBtn.style.display = step<steps.length-1?'inline-block':'none';
            closeBtn.style.display = step===steps.length-1?'inline-block':'none';
        }
        nextBtn.onclick = ()=>{ step++; updateStep(); };
        prevBtn.onclick = ()=>{ step--; updateStep(); };
        closeBtn.onclick = ()=>{
            document.getElementById('welcomeModal').style.display = 'none';
            localStorage.setItem('welcomeSeen','true');
        };
        updateStep();
    }
    // Mostrar solo la primera vez tras login
    window.addEventListener('DOMContentLoaded',()=>{
        if (!sessionStorage.getItem('welcomeShown')) {
            showWelcome();
            sessionStorage.setItem('welcomeShown', 'true');
        }
        document.getElementById('showGuide').onclick = ()=>showWelcome(true);
        // Cerrar modal al hacer clic fuera del contenido
        document.getElementById('welcomeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
    </script>
<div style="text-align:center;margin-top:2.5rem;color:#aaa;font-size:0.95rem;">
    ¬© 2025 Desarrollado por Jorge Aparicio Alvarez. Todos los derechos reservados
  </div>
</body>
</html>
